# ~/.logout

# User-specific shell cleanup script

# Trim HISTFILE
#  - remove entries that contain non-printable characters
#  - remove entries that start with whitespace
#  - remove duplicate entries (keep last)
#  - keep only HISTFILESIZE (default HISTSIZE / 2) most recent entries
if [[ -n $HISTFILE && -s $HISTFILE ]]
then
	histfile="$HISTFILE{new}"
	histfilesize="${HISTFILESIZE:-"$(( ${HISTSIZE:-2047} / 2 ))"}"
	print -s dummy # flush the last command to the history file
	fc -ln 1 \
	| grep -Eav '[^[:blank:][:print:]]' \
	| sed 's/^	//' \
	| grep -Ev -e '^[[:blank:]]' -e '^$' -e '^dummy$' \
	| sed -E -e 's/^[[:blank:][:space:]]+//' -e 's/[[:blank:][:space:]]+$//' \
	| tail -r \
	| awk '!a[$0]++' \
	| head "-$histfilesize" \
	| tail -r \
	> "$histfile"
	mv -f "$histfile" "$HISTFILE"
	unset histfile histfilesize
fi
